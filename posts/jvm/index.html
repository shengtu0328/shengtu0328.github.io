<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>JVM学习 - ricky的网站</title><meta name="Description" content="The best time to plant a tree was 10 years ago, the second is now"><meta property="og:title" content="JVM学习" />
<meta property="og:description" content="一、什么是JVM 定义 Java Virtual Machine，JAVA程序的运行环境（JAVA二进制字节码的运行环境） 好处 一次编写，到处运行 (屏蔽了字节码和操作系" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shengtu0328.github.io/posts/jvm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-11T18:23:30+08:00" />
<meta property="article:modified_time" content="2022-10-11T18:23:30+08:00" /><meta property="og:site_name" content="我的网站" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JVM学习"/>
<meta name="twitter:description" content="一、什么是JVM 定义 Java Virtual Machine，JAVA程序的运行环境（JAVA二进制字节码的运行环境） 好处 一次编写，到处运行 (屏蔽了字节码和操作系"/>
<meta name="application-name" content="我的网站">
<meta name="apple-mobile-web-app-title" content="我的网站"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://shengtu0328.github.io/posts/jvm/" /><link rel="next" href="https://shengtu0328.github.io/posts/spring/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "JVM学习",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/shengtu0328.github.io\/posts\/jvm\/"
        },"genre": "posts","wordcount":  8478 ,
        "url": "https:\/\/shengtu0328.github.io\/posts\/jvm\/","datePublished": "2022-10-11T18:23:30+08:00","dateModified": "2022-10-11T18:23:30+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "ricky"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="ricky的网站">Ricky’s blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="ricky的网站">Ricky’s blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">JVM学习</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>ricky</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-10-11">2022-10-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;8478 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;17 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一什么是jvm">一、什么是JVM</a>
      <ul>
        <li><a href="#定义">定义</a></li>
        <li><a href="#好处">好处</a></li>
        <li><a href="#jvm参数">jvm参数</a></li>
      </ul>
    </li>
    <li><a href="#二内存结构">二、内存结构</a>
      <ul>
        <li><a href="#1程序计数器">1、程序计数器</a>
          <ul>
            <li><a href="#作用">作用</a></li>
            <li><a href="#特点">特点</a></li>
          </ul>
        </li>
        <li><a href="#2虚拟机栈">2、虚拟机栈</a>
          <ul>
            <li><a href="#定义-1">定义</a></li>
            <li><a href="#演示">演示</a></li>
            <li><a href="#问题辨析">问题辨析</a></li>
            <li><a href="#内存溢出">内存溢出</a></li>
            <li><a href="#线程运行诊断">线程运行诊断</a></li>
          </ul>
        </li>
        <li><a href="#3本地方法栈">3、本地方法栈</a></li>
        <li><a href="#4堆">4、堆</a>
          <ul>
            <li><a href="#定义-2">定义</a></li>
            <li><a href="#特点-1">特点</a></li>
            <li><a href="#堆内存溢出">堆内存溢出</a></li>
            <li><a href="#堆内存诊断">堆内存诊断</a></li>
          </ul>
        </li>
        <li><a href="#5方法区">5、方法区</a>
          <ul>
            <li><a href="#定义-3">定义</a></li>
            <li><a href="#内存溢出-1">内存溢出</a></li>
            <li><a href="#常量池">常量池</a>
              <ul>
                <li><a href="#定义-4">定义</a></li>
                <li><a href="#举例说明">举例说明</a></li>
              </ul>
            </li>
            <li><a href="#stringtable串池">StringTable（串池）</a>
              <ul>
                <li><a href="#举例说明依据字节码">举例说明(依据字节码)</a></li>
                <li><a href="#特征">特征</a></li>
                <li><a href="#intern方法-18">intern方法 1.8</a></li>
                <li><a href="#intern方法-16">intern方法 1.6</a></li>
                <li><a href="#垃圾回收">垃圾回收</a></li>
                <li><a href="#stringtable调优">StringTable调优</a></li>
              </ul>
            </li>
            <li><a href="#直接内存">直接内存</a>
              <ul>
                <li><a href="#释放原理">释放原理</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#三垃圾回收">三、垃圾回收</a>
      <ul>
        <li><a href="#1如何判断对象可以回收">1、如何判断对象可以回收</a>
          <ul>
            <li><a href="#引用计数法">引用计数法</a></li>
            <li><a href="#可达性分析算法jvm用的">可达性分析算法（JVM用的）</a></li>
            <li><a href="#五种引用">五种引用</a>
              <ul>
                <li><a href="#强引用">强引用</a></li>
                <li><a href="#软引用">软引用</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="一什么是jvm">一、什么是JVM</h2>
<h3 id="定义">定义</h3>
<p>Java Virtual Machine，JAVA程序的<strong>运行环境</strong>（JAVA二进制字节码的运行环境）</p>
<h3 id="好处">好处</h3>
<ul>
<li>
<p>一次编写，到处运行 (屏蔽了字节码和操作系统和的差异，对外提供一致的操作环境，从而可以跨平台，如在windows，linux运行、)</p>
</li>
<li>
<p>自动内存管理，垃圾回收机制 (c,c++之前没有自动垃圾回收)</p>
</li>
<li>
<p>数组下标越界检查 （c语言也没有?）</p>
</li>
<li>
<p>多态（虚方法表实现？)</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="001.png"
        data-srcset="001.png, 001.png 1.5x, 001.png 2x"
        data-sizes="auto"
        alt="001.png"
        title="001.png" /></p>
<h3 id="jvm参数">jvm参数</h3>
<ul>
<li>
<p>栈内存大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-Xss1024k
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>堆内存大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-Xmx4G
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>永久代大小 1.8 以前</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-XX:MaxPermSize=8m
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>元空间大小 1.8 以后</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-XX:MaxMetaspaceSize=8m
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>堆空间回收不足开关 +是启用，-是不启用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-XX:-UseGCOverheadLimit
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">+XX:-UseGCOverheadLimit
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>StringTable 桶个数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-XX:StringTableSize=20000
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>禁用显示辣鸡回收，如System.gc() 注意：System.gc()是full gc，新生代，老年代。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-XX:+DisableExplicitGC 显式的
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="二内存结构">二、内存结构</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="002.png"
        data-srcset="002.png, 002.png 1.5x, 002.png 2x"
        data-sizes="auto"
        alt="002.png"
        title="002.png" /></p>
<ul>
<li>
<p>方法区:存放了类</p>
</li>
<li>
<p>堆:存放了对象</p>
</li>
<li>
<p>虚拟机栈&amp;程序器计数器&amp;本地方法栈: 对象调用方法时会用到</p>
</li>
<li>
<p>解释器:每行代码执行</p>
</li>
<li>
<p>即时的编译器:热点代码执行</p>
</li>
<li>
<p>辣鸡回收:回收在堆中不被引用的对象</p>
</li>
<li>
<p>本地方法接口:操作系统的功能方法</p>
</li>
</ul>
<h3 id="1程序计数器">1、程序计数器</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="005.png"
        data-srcset="005.png, 005.png 1.5x, 005.png 2x"
        data-sizes="auto"
        alt="005.png"
        title="005.png" /></p>
<h4 id="作用">作用</h4>
<p>用于保存JVM中下一条所要执行的指令的地址</p>
<h4 id="特点">特点</h4>
<ul>
<li>
<p>线程私有</p>
<ul>
<li>CPU会为每个线程分配时间片，当当前线程的时间片使用完以后，CPU就会去执行另一个线程中的代码</li>
<li>程序计数器是<strong>每个线程</strong>所<strong>私有</strong>的，每个线程都有自己的程序计数器，当另一个线程的时间片用完，又返回来执行当前线程的代码时，通过程序计数器可以知道应该执行哪一句指令</li>
</ul>
</li>
<li>
<p>不会存在内存溢出.</p>
</li>
</ul>
<h3 id="2虚拟机栈">2、虚拟机栈</h3>
<h4 id="定义-1">定义</h4>
<ul>
<li>每个<strong>线程</strong>运行需要的内存空间，称为<strong>虚拟机栈</strong></li>
<li>每个栈由多个<strong>栈帧</strong>组成，对应着每次调用<strong>方法</strong>时所占用的内存</li>
<li>每个线程只能有<strong>一个活动栈帧</strong>，对应着<strong>当前正在执行的方法</strong></li>
<li>Student s=new Student()；s这个变量也是在栈里，new Student()对象是在堆里</li>
</ul>
<h4 id="演示">演示</h4>
<p>代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">public class Main {
	public static void main(String[] args) {
		method1();
	}

	private static void method1() {
		method2(1, 2);
	}

	private static int method2(int a, int b) {
		int c = a + b;
		return c;
	}
}
</code></pre></td></tr></table>
</div>
</div><p>可以参考idea debug模式下的 Frames</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="008_stack.png"
        data-srcset="008_stack.png, 008_stack.png 1.5x, 008_stack.png 2x"
        data-sizes="auto"
        alt="008_stack.png"
        title="008_stack.png" /></p>
<h4 id="问题辨析">问题辨析</h4>
<ul>
<li>
<p>垃圾回收是否涉及栈内存？</p>
<ul>
<li><strong>不需要</strong>。因为虚拟机栈中是由一个个栈帧组成的，在方法执行完毕后，对应的栈帧就会被弹出栈。所以无需通过垃圾回收机制去回收内存。</li>
</ul>
</li>
<li>
<p>栈内存的分配越大越好吗？</p>
<ul>
<li>不是。因为<strong>物理内存是一定的</strong>，栈内存越大，可以支持更多的递归调用，但是可执行的线程数就会越少。</li>
<li>线程数=物理内存/栈内存</li>
<li>-Xss1024k （栈内存JVM默认参数配置，默认大小是1M）</li>
</ul>
</li>
<li>
<p>方法内的局部变量是否是线程安全的？</p>
<ul>
<li>如果方法内<strong>局部变量没有逃离方法的作用范围</strong>，则是<strong>线程安全</strong>的</li>
<li>如果如果<strong>局部变量引用了对象</strong>或者静态变量，并<strong>逃离了方法的作用范围</strong>，则需要考虑线程安全问题</li>
</ul>
</li>
</ul>
<h4 id="内存溢出">内存溢出</h4>
<p><strong>Java.lang.stackOverflowError</strong> 栈内存溢出</p>
<p><strong>发生原因</strong></p>
<ul>
<li>
<p>虚拟机栈中，<strong>栈帧过多</strong>（无限递归，第三方库出现的问题如json序列化对象互相引用）</p>
</li>
<li>
<p>每个栈帧<strong>所占用过大</strong></p>
<p>可以通过idea中Configurations中设置VM options 设置jvm参数：如-Xss256k</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="012.png"
        data-srcset="012.png, 012.png 1.5x, 012.png 2x"
        data-sizes="auto"
        alt="012.png"
        title="012.png" /></p>
</li>
</ul>
<h4 id="线程运行诊断">线程运行诊断</h4>
<p>CPU占用过高</p>
<ul>
<li>Linux环境下运行某些程序的时候，可能导致CPU的占用过高，这时需要定位占用CPU过高的线程
<ul>
<li>
<p><strong>top</strong></p>
<p>查看<strong>进程</strong>的CPU和内存使用情况,会显示进程id(PID),但还定位不到线程，</p>
</li>
<li>
<p><strong>ps H -eo pid,tid,%cpu | grep 我是刚才通过top查到的进程号</strong></p>
<p>查看<strong>线程</strong>占用CPU和内存使用情况</p>
<p><strong>H</strong> 是显示进程里所有线程树的意思</p>
<p><strong>-eo</strong>是输出结果 ，**pid:**进程id，<strong>tid:<strong>线程id，,</strong>%cpu</strong>:cpu占用率</p>
</li>
<li>
<p><strong>jstack 我是一个进程id</strong></p>
<p>通过查看进程中的线程的id，刚才通过ps命令看到的tid来<strong>对比定位</strong>，注意jstack查找出的线程id是<strong>16进制的</strong>，<strong>需要转换</strong></p>
</li>
</ul>
</li>
</ul>
<h3 id="3本地方法栈">3、本地方法栈</h3>
<p>​    <img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="016_nativeMethod.png"
        data-srcset="016_nativeMethod.png, 016_nativeMethod.png 1.5x, 016_nativeMethod.png 2x"
        data-sizes="auto"
        alt="016_nativeMethod.png"
        title="016_nativeMethod.png" /></p>
<p>一些带有<strong>native关键字</strong>的方法就是需要JAVA去调用本地的C或者C++方法，因为JAVA有时候没法直接和操作系统底层交互，所以需要用到本地方法</p>
<h3 id="4堆">4、堆</h3>
<p>Heap 堆</p>
<p>​    <img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="017_%e5%a0%86.png"
        data-srcset="017_%e5%a0%86.png, 017_%e5%a0%86.png 1.5x, 017_%e5%a0%86.png 2x"
        data-sizes="auto"
        alt="017_堆.png"
        title="017_堆.png" /></p>
<h4 id="定义-2">定义</h4>
<p>通过new关键字<strong>创建的对象</strong>都会被放在堆内存</p>
<h4 id="特点-1">特点</h4>
<ul>
<li><strong>所有线程共享</strong>，堆内存中的对象都需要<strong>考虑线程安全问题</strong></li>
<li>有垃圾回收机制</li>
<li>jvm参数：-Xmx4G   可以通过修改jvm堆内存的参数大小，尽早暴露问题</li>
</ul>
<h4 id="堆内存溢出">堆内存溢出</h4>
<p><strong>java.lang.OutofMemoryError</strong> ：java heap space. 堆内存溢出</p>
<p>比如一个size很大的list，就会发生堆内存溢出</p>
<h4 id="堆内存诊断">堆内存诊断</h4>
<ol>
<li>jps 工具</li>
</ol>
<ul>
<li>
<p>查看当前系统中有哪些 java 进程</p>
</li>
<li>
<p>jps</p>
</li>
</ul>
<ol start="2">
<li>jmap 工具</li>
</ol>
<ul>
<li>
<p>查看堆内存占用情况 jmap - heap 进程id，只能是某一时刻</p>
</li>
<li>
<p>jmap -heap 5750</p>
</li>
</ul>
<ol start="3">
<li>jconsole 工具</li>
</ol>
<ul>
<li>
<p>图形界面的，多功能的监测工具，可以连续监测</p>
</li>
<li>
<p>jconsole</p>
<p>​    <img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="020_jconsole.png"
        data-srcset="020_jconsole.png, 020_jconsole.png 1.5x, 020_jconsole.png 2x"
        data-sizes="auto"
        alt="020_jconsole.png"
        title="020_jconsole.png" /></p>
</li>
</ul>
<ol start="4">
<li>java VisualVm</li>
</ol>
<ul>
<li>
<p>jvisualvm 图形界面，更加强大，类似idea debug模式下看到的信息</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="021_jvisualvm.png"
        data-srcset="021_jvisualvm.png, 021_jvisualvm.png 1.5x, 021_jvisualvm.png 2x"
        data-sizes="auto"
        alt="021_jvisualvm.png"
        title="021_jvisualvm.png" /></p>
</li>
</ul>
<h3 id="5方法区">5、方法区</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="022_%e6%96%b9%e6%b3%95%e5%8c%ba.png"
        data-srcset="022_%e6%96%b9%e6%b3%95%e5%8c%ba.png, 022_%e6%96%b9%e6%b3%95%e5%8c%ba.png 1.5x, 022_%e6%96%b9%e6%b3%95%e5%8c%ba.png 2x"
        data-sizes="auto"
        alt="022_方法区.png"
        title="022_方法区.png" /></p>
<p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4" target="_blank" rel="noopener noreffer ">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4</a></p>
<p>The Java Virtual Machine has a <em><strong>method area</strong></em> that is <strong>shared among all Java Virtual Machine threads</strong>. The method area is analogous（相似的） to the storage area for compiled code of a conventional language or analogous to the &ldquo;text&rdquo; segment in an operating system process. It stores per-class structures such as the run-time constant pool（<strong>运行时常量池</strong>), field （ ）and method data, and the code for methods(<strong>方法</strong>) and constructors（<strong>构造方法</strong>）, including the special methods (<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9" target="_blank" rel="noopener noreffer ">§2.9</a>) used in class and instance initialization and interface initialization.</p>
<p>The method area is created on virtual machine start-up. Although the method area is logically part of the heap, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.</p>
<h4 id="定义-3">定义</h4>
<ul>
<li>
<p>方法区是所有线程共享的，存储了运行时常量池，类模板。</p>
</li>
<li>
<p>方法区逻辑上定义为在堆中。</p>
<p>1.8以前叫永久代，用的堆。</p>
<p>1.8以后用叫元空间，用的操作系统内存。StringTable串池还是在堆中</p>
</li>
<li>
<p>方法区也会内存溢出</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="022_%e6%96%b9%e6%b3%95%e5%8c%ba%e5%ae%9a%e4%b9%89.png"
        data-srcset="022_%e6%96%b9%e6%b3%95%e5%8c%ba%e5%ae%9a%e4%b9%89.png, 022_%e6%96%b9%e6%b3%95%e5%8c%ba%e5%ae%9a%e4%b9%89.png 1.5x, 022_%e6%96%b9%e6%b3%95%e5%8c%ba%e5%ae%9a%e4%b9%89.png 2x"
        data-sizes="auto"
        alt="022_方法区定义.png"
        title="022_方法区定义.png" /></p>
</li>
</ul>
<h4 id="内存溢出-1">内存溢出</h4>
<p>jvm参数： -XX:MaxMetaspaceSize=8m</p>
<p>1.8 以前会导致永久代内存溢出</p>
<ul>
<li>演示永久代内存溢出 java.lang.OutOfMemoryError: PermGen space</li>
<li>-XX:MaxPermSize=8m</li>
</ul>
<p>1.8 之后会导致元空间内存溢出</p>
<ul>
<li>
<p>演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace</p>
</li>
<li>
<p>-XX:MaxMetaspaceSize=8m</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">/**
 * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace
 * 元空间 大小参数设置
 * -XX:MaxMetaspaceSize=8m
 */
public class Demo1_8 extends ClassLoader { // 可以用来加载类的二进制字节码
    public static void main(String[] args) {
        int j = 0;
        try {
            Demo1_8 test = new Demo1_8();
            for (int i = 0; i &lt; 10000; i++, j++) {
                // ClassWriter 作用是生成类的二进制字节码
                ClassWriter cw = new ClassWriter(0);
                //参数定义: 版本号， public， 类名, 包名, 父类， 接口
                cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, &#34;Class&#34; + i, null, &#34;java/lang/Object&#34;, null);
                // 返回 byte[]
                byte[] code = cw.toByteArray();
                // 执行了类的加载
                test.defineClass(&#34;Class&#34; + i, code, 0, code.length); // Class 对象
            }
        } finally {
            System.out.println(j);
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><p>工作中加载类的场景</p>
<ul>
<li>
<p>spring</p>
</li>
<li>
<p>mybatis</p>
</li>
</ul>
<h4 id="常量池">常量池</h4>
<h5 id="定义-4">定义</h5>
<ul>
<li>
<p>常量池</p>
<p>就是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量（即参数，字符串，布尔类型，整形）信息</p>
</li>
<li>
<p>运行时常量池
常量池是*.class文件中的，当该<strong>类被加载以后</strong>，它的常量池信息就会放入运行时常量池（也就是内存中），并把里面的符号地址变为真实地址。(即#1，#2变成物理地址)</p>
</li>
</ul>
<h5 id="举例说明">举例说明</h5>
<p>用java代码反编译举个例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> // 二进制字节码（类基本信息，常量池，类方法定义，包含了虚拟机指令）
 public class HelloWorld {
     public static void main(String[] args) {
         System.out.println(&#34;hello world&#34;);
     }
 }
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>javap -v HelloWorld.class</p>
<p>反编译</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">========================类基本信息========================
  Last modified 2022-10-14; size 567 bytes
  MD5 checksum 8efebdac91aa496515fa1c161184e354
  Compiled from &#34;HelloWorld.java&#34;
public class cn.itcast.jvm.t5.HelloWorld
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
  
========================常量池========================
Constant pool:
   #1 = Methodref          #6.#20         // java/lang/Object.&#34;&lt;init&gt;&#34;:()V
   #2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;
   #3 = String             #23            // hello world
   #4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #5 = Class              #26            // cn/itcast/jvm/t5/HelloWorld
   #6 = Class              #27            // java/lang/Object
   #7 = Utf8               &lt;init&gt;
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lcn/itcast/jvm/t5/HelloWorld;
  #14 = Utf8               main
  #15 = Utf8               ([Ljava/lang/String;)V
  #16 = Utf8               args
  #17 = Utf8               [Ljava/lang/String;
  #18 = Utf8               SourceFile
  #19 = Utf8               HelloWorld.java
  #20 = NameAndType        #7:#8          // &#34;&lt;init&gt;&#34;:()V
  #21 = Class              #28            // java/lang/System
  #22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;
  #23 = Utf8               hello world
  #24 = Class              #31            // java/io/PrintStream
  #25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V
  #26 = Utf8               cn/itcast/jvm/t5/HelloWorld
  #27 = Utf8               java/lang/Object
  #28 = Utf8               java/lang/System
  #29 = Utf8               out
  #30 = Utf8               Ljava/io/PrintStream;
  #31 = Utf8               java/io/PrintStream
  #32 = Utf8               println
  #33 = Utf8               (Ljava/lang/String;)V
  
    
========================类方法定义========================
{
  public cn.itcast.jvm.t5.HelloWorld();       //构造方法
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
         4: return
      LineNumberTable:
        line 4: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcn/itcast/jvm/t5/HelloWorld;

  public static void main(java.lang.String[]);    //main 方法
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #2                  // 获取System.out这个静态变量
         3: ldc           #3                  // String hello world 加载一个参数
         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V 虚方法调用
         8: return
      LineNumberTable:
        line 6: 0
        line 7: 8
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       9     0  args   [Ljava/lang/String;
}
SourceFile: &#34;HelloWorld.java&#34;

</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>翻译下就是</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>getstatic #2</td>
<td>去常量池(Constant pool）找 #2 的变量,最终找到了System.out这个静态成员变量</td>
</tr>
<tr>
<td></td>
<td>#2 = Fieldref 是一个成员变量的引用</td>
</tr>
<tr>
<td></td>
<td>#2-&gt;#21.#22</td>
</tr>
<tr>
<td></td>
<td>#21 = Class              #28</td>
</tr>
<tr>
<td></td>
<td>#22 = NameAndType        #29:#30</td>
</tr>
<tr>
<td></td>
<td>#28 = Utf8               java/lang/System</td>
</tr>
<tr>
<td></td>
<td>#29 = Utf8               out</td>
</tr>
<tr>
<td></td>
<td>#30 = Utf8               Ljava/io/PrintStream;</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>ldc           #3</td>
<td>#3 = String             #23</td>
</tr>
<tr>
<td></td>
<td>#23 = Utf8               hello world</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>invokevirtual #4</td>
<td>找到 java/io/PrintStream对象的println方法 参数是:(Ljava/lang/String;)V，并调用</td>
</tr>
<tr>
<td></td>
<td>#4 = Methodref          #24.#25</td>
</tr>
<tr>
<td></td>
<td>#24 = Class              #31</td>
</tr>
<tr>
<td></td>
<td>#25 = NameAndType        #32:#33</td>
</tr>
<tr>
<td></td>
<td>#31 = Utf8               java/io/PrintStream</td>
</tr>
<tr>
<td></td>
<td>#32 = Utf8               println</td>
</tr>
<tr>
<td></td>
<td>#33 = Utf8               (Ljava/lang/String;)V</td>
</tr>
</tbody>
</table>
<h4 id="stringtable串池">StringTable（串池）</h4>
<p>常量池-&gt;运行时常量池-</p>
<p>执行语句 String str = &ldquo;abc&rdquo; 时，首先查看字符串池中是否存在字符串&quot;abc&quot; ，如果存在则直接将&quot;abc&quot;地址赋给str ，如果不存在则先在字符串池中新建一个字符串&quot;abc&quot;，然后再将其赋给str。</p>
<p>String str = new String(“aa”)：至少会创建一个对象，也有可能创建两个。用到new关键字，肯定会在堆中创建一个String对象，如果字符池中已经存在”abc”,则不会在字符串池中创建一个String对象，如果不存在，则会在字符串常量池中也创建一个对象。</p>
<p>直到用到了该符号，才会创建对应的字符串对象放入字符串常量池</p>
<h5 id="举例说明依据字节码">举例说明(依据字节码)</h5>
<p>java代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// StringTable [ &#34;a&#34;, &#34;b&#34; ,&#34;ab&#34; ]  hashtable 结构，不能扩容
public class Demo1_22 {
    // 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象
    // ldc #2 会把 a 符号变为 &#34;a&#34; 字符串对象
    // ldc #3 会把 b 符号变为 &#34;b&#34; 字符串对象
    // ldc #4 会把 ab 符号变为 &#34;ab&#34; 字符串对象

    public static void main(String[] args) {
        String s1 = &#34;a&#34;; // 懒惰的
        String s2 = &#34;b&#34;;
        String s3 = &#34;ab&#34;;
        String s4 = s1 + s2; //通过字节码可以知道，实际上是 new StringBuilder().append(&#34;a&#34;).append(&#34;b&#34;).toString() 和  new String(&#34;ab&#34;)
        System.out.println(s3 == s4);// false  因为s3在串池，s4在堆中
        String s5 = &#34;a&#34; + &#34;b&#34;;  // javac 在编译期间的优化，结果已经在编译期确定为ab
        System.out.println(s3 == s5);//true 因为都是在串池

    }
}

</code></pre></td></tr></table>
</div>
</div><p>java字节码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Classfile /G:/xrqProjects/jvm/代码/jvm/out/production/jvm/cn/itcast/jvm/t1/stringtable/Demo1_22.class
  Last modified 2022-10-17; size 1057 bytes
  MD5 checksum b94bb46c9f03f10beb6d57556ca42557
  Compiled from &#34;Demo1_22.java&#34;
public class cn.itcast.jvm.t1.stringtable.Demo1_22
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #12.#36        // java/lang/Object.&#34;&lt;init&gt;&#34;:()V
   #2 = String             #37            // a
   #3 = String             #38            // b
   #4 = String             #39            // ab
   #5 = Class              #40            // java/lang/StringBuilder
   #6 = Methodref          #5.#36         // java/lang/StringBuilder.&#34;&lt;init&gt;&#34;:()V
   #7 = Methodref          #5.#41         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
   #8 = Methodref          #5.#42         // java/lang/StringBuilder.toString:()Ljava/lang/String;
   #9 = Fieldref           #43.#44        // java/lang/System.out:Ljava/io/PrintStream;
  #10 = Methodref          #45.#46        // java/io/PrintStream.println:(Z)V
  #11 = Class              #47            // cn/itcast/jvm/t1/stringtable/Demo1_22
  #12 = Class              #48            // java/lang/Object
  #13 = Utf8               &lt;init&gt;
  #14 = Utf8               ()V
  #15 = Utf8               Code
  #16 = Utf8               LineNumberTable
  #17 = Utf8               LocalVariableTable
  #18 = Utf8               this
  #19 = Utf8               Lcn/itcast/jvm/t1/stringtable/Demo1_22;
  #20 = Utf8               main
  #21 = Utf8               ([Ljava/lang/String;)V
  #22 = Utf8               args
  #23 = Utf8               [Ljava/lang/String;
  #24 = Utf8               s1
  #25 = Utf8               Ljava/lang/String;
  #26 = Utf8               s2
  #27 = Utf8               s3
  #28 = Utf8               s4
  #29 = Utf8               s5
  #30 = Utf8               StackMapTable
  #31 = Class              #23            // &#34;[Ljava/lang/String;&#34;
  #32 = Class              #49            // java/lang/String
  #33 = Class              #50            // java/io/PrintStream
  #34 = Utf8               SourceFile
  #35 = Utf8               Demo1_22.java
  #36 = NameAndType        #13:#14        // &#34;&lt;init&gt;&#34;:()V
  #37 = Utf8               a
  #38 = Utf8               b
  #39 = Utf8               ab
  #40 = Utf8               java/lang/StringBuilder
  #41 = NameAndType        #51:#52        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
  #42 = NameAndType        #53:#54        // toString:()Ljava/lang/String;
  #43 = Class              #55            // java/lang/System
  #44 = NameAndType        #56:#57        // out:Ljava/io/PrintStream;
  #45 = Class              #50            // java/io/PrintStream
  #46 = NameAndType        #58:#59        // println:(Z)V
  #47 = Utf8               cn/itcast/jvm/t1/stringtable/Demo1_22
  #48 = Utf8               java/lang/Object
  #49 = Utf8               java/lang/String
  #50 = Utf8               java/io/PrintStream
  #51 = Utf8               append
  #52 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;
  #53 = Utf8               toString
  #54 = Utf8               ()Ljava/lang/String;
  #55 = Utf8               java/lang/System
  #56 = Utf8               out
  #57 = Utf8               Ljava/io/PrintStream;
  #58 = Utf8               println
  #59 = Utf8               (Z)V
{
  public cn.itcast.jvm.t1.stringtable.Demo1_22();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
         4: return
      LineNumberTable:
        line 4: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcn/itcast/jvm/t1/stringtable/Demo1_22;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=3, locals=6, args_size=1
         0: ldc           #2                  // String a
         2: astore_1
         3: ldc           #3                  // String b
         5: astore_2
         6: ldc           #4                  // String ab  s3 == s5 为true!!!!!!!!!!!!!!!!!!!!!
         8: astore_3
         9: new           #5                  // class java/lang/StringBuilder
        12: dup
        13: invokespecial #6                  // Method java/lang/StringBuilder.&#34;&lt;init&gt;&#34;:()V
        16: aload_1
        17: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        20: aload_2
        21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        27: astore        4
        29: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
        32: aload_3
        33: aload         4
        35: if_acmpne     42
        38: iconst_1
        39: goto          43
        42: iconst_0
        43: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V
        46: ldc           #4                  // String ab    s3 == s5 为true!!!!!!!!!!!!!!!!!!!!!
        48: astore        5
        50: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
        53: aload_3
        54: aload         5
        56: if_acmpne     63
        59: iconst_1
        60: goto          64
        63: iconst_0
        64: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V
        67: return
      LineNumberTable:
        line 11: 0
        line 12: 3
        line 13: 6
        line 14: 9
        line 15: 29
        line 16: 46
        line 17: 50
        line 19: 67
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      68     0  args   [Ljava/lang/String;
            3      65     1    s1   Ljava/lang/String;
            6      62     2    s2   Ljava/lang/String;
            9      59     3    s3   Ljava/lang/String;
           29      39     4    s4   Ljava/lang/String;
           50      18     5    s5   Ljava/lang/String;
      StackMapTable: number_of_entries = 4
        frame_type = 255 /* full_frame */
          offset_delta = 42
          locals = [ class &#34;[Ljava/lang/String;&#34;, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String ]
          stack = [ class java/io/PrintStream ]
        frame_type = 255 /* full_frame */
          offset_delta = 0
          locals = [ class &#34;[Ljava/lang/String;&#34;, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String ]
          stack = [ class java/io/PrintStream, int ]
        frame_type = 255 /* full_frame */
          offset_delta = 19
          locals = [ class &#34;[Ljava/lang/String;&#34;, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String ]
          stack = [ class java/io/PrintStream ]
        frame_type = 255 /* full_frame */
          offset_delta = 0
          locals = [ class &#34;[Ljava/lang/String;&#34;, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String ]
          stack = [ class java/io/PrintStream, int ]
}
SourceFile: &#34;Demo1_22.java&#34;

</code></pre></td></tr></table>
</div>
</div><h5 id="特征">特征</h5>
<ul>
<li>常量池中的字符串仅是符号，只有<strong>在被用到时才会转化为对象</strong></li>
<li>利用串池的机制，来避免重复创建字符串对象</li>
<li>字符串<strong>变量</strong>拼接的原理是<strong>StringBuilder</strong></li>
<li>字符串<strong>常量</strong>拼接的原理是<strong>编译器优化</strong></li>
<li>可以使用<strong>intern方法</strong>，主动将串池中还没有的字符串对象放入串池中</li>
<li><strong>注意</strong>：无论是串池还是堆里面的字符串，都是对象</li>
</ul>
<h5 id="intern方法-18">intern方法 1.8</h5>
<p>调用字符串对象的intern方法，会将该字符串对象<strong>的引用</strong>尝试放入到串池中</p>
<ul>
<li>
<p>如果串池中没有该字符串对象，则放入</p>
</li>
<li>
<p>如果有该字符串对象，则不会放入</p>
<p>无论放入是否成功，都会返回<strong>串池中</strong>的字符串对象</p>
</li>
</ul>
<p>JDK 1.7后，intern方法还是会先去查询常量池中是否有已经存在，如果存在，则返回常量池中的引用，这一点与之前没有区别，区别在于，如果在常量池找不到对应的字符串，则不会再将字符串拷贝到常量池，而只是在常量池中生成一个对原字符串的引用。简单的说，就是往常量池放的东西变了：原来在常量池中找不到时，复制一个副本放到常量池，1.7后则是将在堆上的地址引用复制到常量池。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">例子1：先创建堆字符串，再intern()
public static void main(String[] args) {
    //串池：【&#34;a&#34; &#34;b&#34;】,堆：【new String(&#34;a&#34;)，new String(&#34;b&#34;), new String(&#34;ab&#34;)】
    String s = new String(&#34;a&#34;) + new String(&#34;b&#34;);

    //调用intern方法，这时串池中没有&#34;ab&#34;，则会将s这个对象引用放入到串池中，此时堆内存与串池中的&#34;ab&#34;是同一个字符串对象的引用
    String s2 = s.intern();

    //与串池中的ab对象做比较 返回true
    System.out.println(s2 == &#34;ab&#34;);

    //比较的是引用 返回true  jdk1.6这里是false
    System.out.println(s == &#34;ab&#34;);
}
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">例子2：先创建串池字符串，后创建堆中字符串，再intern()
public static void main(String[] args) {
    //串池：【&#34;ab&#34;】
    String x = &#34;ab&#34;;

    //串池：【&#34;ab&#34;,&#34;a&#34; &#34;b&#34;】,这一步只是添加了【&#34;a&#34; &#34;b&#34;】
    //并且在堆中创建了 s对象 ，s和x不是同一个对象，因为是串池中的“ab”先创建，堆中拼接后创建
    String s = new String(&#34;a&#34;) + new String(&#34;b&#34;);

    //串池中已经有ab了，所以s被没有被放进去，返回的是串池中的对象
    String s2 = s.intern();

    //s2和x都是串池中的对象 返回true
    System.out.println(s2 == x);

    //s是堆中的对象 x串池中对象 返回false
    System.out.println(s == x);
}
</code></pre></td></tr></table>
</div>
</div><h5 id="intern方法-16">intern方法 1.6</h5>
<p>调用字符串对象的intern方法，会将该字符串对象尝试放入到串池中</p>
<ul>
<li>如果串池中没有该字符串对象，<strong>会将该字符串对象复制一份</strong>，再放入到串池中</li>
<li>如果有该字符串对象，则放入失败</li>
</ul>
<p>无论放入是否成功，都会返回<strong>串池中</strong>的字符串对象</p>
<p><strong>注意</strong>：此时无论调用intern方法成功与否，串池中的字符串对象和堆内存中的字符串对象<strong>都不是同一个对象</strong>，上面例子1中  System.out.println(s== &ldquo;ab&rdquo;);返回false</p>
<h5 id="垃圾回收">垃圾回收</h5>
<p>StringTable在内存紧张时，会发生垃圾回收</p>
<p>在jvm1.6中，StringTable是常量池的一部分。</p>
<p>在jvm1.8中，StringTable存在了堆中。</p>
<p>为什么要变呢？因为永久代是在full gc的时候，才会gc。触发的时间比较慢。导致StringTable 回收效率不高。但StringTable 使用频繁，如java程序中会大量使用字符串常量。回收效率不高会占用大量内存，有可能会导致永久代内存不足。在堆中只要minor gc就会触发gc。</p>
<p>注意：</p>
<p>1.6永久代和堆逻辑上是相互隔离的，但它们使用的物理内存是连续的。</p>
<p>1.8元空间不再与堆连续，而且是存在于本地内存（Native memory）</p>
<p><a href="https://blog.csdn.net/ju_362204801/article/details/122379813" target="_blank" rel="noopener noreffer ">https://blog.csdn.net/ju_362204801/article/details/122379813</a></p>
<h5 id="stringtable调优">StringTable调优</h5>
<ul>
<li>StringTable是由类似juc里的HashTable实现的，所以可以<strong>适当增加桶的个数</strong>，从而减少哈希碰撞，来减少字符串放入串池所需要的时间。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">-XX:StringTableSize=20000
</code></pre></td></tr></table>
</div>
</div><ul>
<li>如果有大量的字符串，并且有不少是重复的，可以通过intern方法减去重后入池，减少内存占用。因为在串池中，相同的字符串在串池只会存储一份。</li>
</ul>
<h4 id="直接内存">直接内存</h4>
<ul>
<li>
<p>属于操作系统，常见于NIO操作时，<strong>用于数据缓冲区</strong></p>
</li>
<li>
<p>分配回收成本较高，但读写性能高</p>
</li>
<li>
<p>不受JVM内存回收管理</p>
</li>
<li>
<p>java 想要读取文件时，需要从用户态切换到内核态，通过内核态将文件先读取到系统缓冲区，再读取到java缓冲区。</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ad%98_Io.png"
        data-srcset="042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ad%98_Io.png, 042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ad%98_Io.png 1.5x, 042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ad%98_Io.png 2x"
        data-sizes="auto"
        alt="042_直接内存_Io.png"
        title="042_直接内存_Io.png" /></p>
<ul>
<li>直接内存是操作系统和Java代码都可以访问的一块区域，无需将代码从系统内存复制到Java堆内存，从而提高了效率。比如nio中的ByteBuffer.allocateDirect(16)。</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ae%b9_nio.png"
        data-srcset="042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ae%b9_nio.png, 042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ae%b9_nio.png 1.5x, 042_%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ae%b9_nio.png 2x"
        data-sizes="auto"
        alt="042_直接内容_nio.png"
        title="042_直接内容_nio.png" /></p>
<ul>
<li>class java.nio.HeapByteBuffer          -java 堆内存，读写效率较低 ，就和普通javabean 对象一会受到GC影响</li>
<li>class java.nio.DirectByteBuffer        -直接内存 ，读写效率高（少一次拷贝），不会受到java GC的影响，分配内存效率低,但是也会有内存溢出的限制。</li>
</ul>
<h5 id="释放原理">释放原理</h5>
<p>java.nio.DirectByteBuffer 直接内存的回收不是通过JVM的垃圾回收来释放的，而是最终通过<strong>unsafe.freeMemory</strong>来手动释放</p>
<ul>
<li>使用了Unsafe类来完成直接内存的分配回收，回收需要主动调用freeMemory方法</li>
<li>ByteBuffer的实现内部使用了Cleaner（虚引用）来检测ByteBuffer。一旦ByteBuffer被垃圾回收，那么会由ReferenceHandler来调用Cleaner的clean方法调用freeMemory来释放内存</li>
<li>如果java中 ByteBuffer对象没有垃圾回收，直接内存对象不会自动回收，需要通过<strong>unsafe.freeMemory</strong>来手动释放</li>
</ul>
<p>通过 ByteBuffer.allocateDirect 得到DirectByteBuffer</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">ByteBuffer bb = ByteBuffer.allocateDirect(1024 * 1024)
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> DirectByteBuffer(int cap) {                   // package-private

        super(-1, 0, cap, cap);
        boolean pa = VM.isDirectMemoryPageAligned();
        int ps = Bits.pageSize();
        long size = Math.max(1L, (long)cap + (pa ? ps : 0));
        Bits.reserveMemory(size, cap);

        long base = 0;
        try {
            base = unsafe.allocateMemory(size);// 分配了DirectByteBuffer对象的直接内存！！！！！！！！！！！！！！！
        } catch (OutOfMemoryError x) {
            Bits.unreserveMemory(size, cap);
            throw x;
        }
        unsafe.setMemory(base, size, (byte) 0);
        if (pa &amp;&amp; (base % ps != 0)) {
            // Round up to page boundary
            address = base + ps - (base &amp; (ps - 1));
        } else {
            address = base;
        }
        //Cleaner是个虚引用类型 Cleaner extends PhantomReference&lt;Object&gt;，当它所关联的对象被gc时，会触发它的clean方法。也就是this对象触发gc时，会调用Cleaner 的clean方法。
        //本例中就是调用Deallocator里的 run方法 用unsafe 方式进行直接内存的回收
        //在后台有个专门检测虚引用对象的ReferenceHandler 线程中clean方法执行。
        cleaner = Cleaner.create(this, new Deallocator(base, size, cap));//
        att = null;



    }
</code></pre></td></tr></table>
</div>
</div><p>回调任务对象Deallocator会释放DirectByteBuffer对象的直接内存！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> #Cleaner的 回调任务对象 
 private static class Deallocator
        implements Runnable
    {

        private static Unsafe unsafe = Unsafe.getUnsafe();

        private long address;
        private long size;
        private int capacity;

        private Deallocator(long address, long size, int capacity) {
            assert (address != 0);
            this.address = address;
            this.size = size;
            this.capacity = capacity;
        }

        public void run() {
            if (address == 0) {
                // Paranoia
                return;
            }
            unsafe.freeMemory(address);// 释放了DirectByteBuffer对象的直接内存！！！！！！！！！！！！！！！
            address = 0;
            Bits.unreserveMemory(size, capacity);      
        }

    }
</code></pre></td></tr></table>
</div>
</div><h2 id="三垃圾回收">三、垃圾回收</h2>
<h3 id="1如何判断对象可以回收">1、如何判断对象可以回收</h3>
<h4 id="引用计数法">引用计数法</h4>
<p>只要这个对象被其他对象引用就 计数加一，不再被引用就减一。0代表可以回收。</p>
<p>弊端：循环引用时，两个对象的计数都为1，导致两个对象都无法被释放</p>
<h4 id="可达性分析算法jvm用的">可达性分析算法（JVM用的）</h4>
<ul>
<li>
<p>JVM中的垃圾回收器通过<strong>可达性分析</strong>来探索所有存活的对象</p>
</li>
<li>
<p>扫描 <strong>堆</strong> 中的对象，看能否沿着GC Root对象为起点的引用链找到该对象，如果<strong>找不到，则表示可以回收</strong></p>
<p>例子：抓住葡萄的根，连着的葡萄就是不可辣鸡回收的对象，落下的葡萄就是可辣鸡回收的对象</p>
</li>
<li>
<p>可以作为GC Root的对象，指肯定不能被辣鸡回收 的对象</p>
<ul>
<li>虚拟机栈（栈帧中的本地变量表）中引用的对象。　</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>本地方法栈中JNI（即一般说的Native方法）引用的对象</li>
</ul>
</li>
</ul>
<h4 id="五种引用">五种引用</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="054_5%e7%a7%8d%e5%bc%95%e7%94%a8.png"
        data-srcset="054_5%e7%a7%8d%e5%bc%95%e7%94%a8.png, 054_5%e7%a7%8d%e5%bc%95%e7%94%a8.png 1.5x, 054_5%e7%a7%8d%e5%bc%95%e7%94%a8.png 2x"
        data-sizes="auto"
        alt="054_5种引用.png"
        title="054_5种引用.png" /></p>
<h5 id="强引用">强引用</h5>
<p>只有GC Root<strong>都不引用</strong>该对象时，才会回收<strong>强引用</strong>对象</p>
<ul>
<li>如上图B、C对象都不引用A1对象时，A1对象才会被回收</li>
</ul>
<h5 id="软引用">软引用</h5>
<p>当GC Root指向软引用对象时，在<strong>内存不足时</strong>，会<strong>回收软引用所引用的对象</strong></p>
<ul>
<li>如上图如果B对象不再引用A2对象且内存不足时，软引用所引用的A2对象就会被回收</li>
</ul>
<p>软引用的使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">    public static void soft() {
        // list --&gt; SoftReference --&gt; byte[]

        List&lt;SoftReference&lt;byte[]&gt;&gt; list = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; 5; i++) {
            SoftReference&lt;byte[]&gt; ref = new SoftReference&lt;&gt;(new byte[_4MB]);
            System.out.println(ref.get());
            list.add(ref);
            System.out.println(list.size());

        }
        System.out.println(&#34;循环结束：&#34; + list.size());
        for (SoftReference&lt;byte[]&gt; ref : list) {
            System.out.println(ref.get());
        }
    }
    
    
    
Connected to the target VM, address: &#39;127.0.0.1:65198&#39;, transport: &#39;socket&#39;
[B@6f75e721
1
[B@69222c14
2
[B@606d8acf
3
[GC (Allocation Failure) [PSYoungGen: 1777K-&gt;464K(6144K)] 14065K-&gt;12760K(19968K), 0.0007427 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[B@782830e
4
[GC (Allocation Failure) --[PSYoungGen: 4672K-&gt;4672K(6144K)] 16968K-&gt;16968K(19968K), 0.0007738 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
[Full GC (Ergonomics) [PSYoungGen: 4672K-&gt;4471K(6144K)] [ParOldGen: 12296K-&gt;12289K(13824K)] 16968K-&gt;16760K(19968K), [Metaspace: 2843K-&gt;2843K(1056768K)], 0.0047325 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) --[PSYoungGen: 4471K-&gt;4471K(6144K)] 16760K-&gt;16760K(19968K), 0.0007396 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 4471K-&gt;0K(6144K)] [ParOldGen: 12289K-&gt;361K(8192K)] 16760K-&gt;361K(14336K), [Metaspace: 2843K-&gt;2843K(1056768K)], 0.0072134 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
[B@470e2030
5
循环结束：5
null
null
null
null
[B@470e2030
Heap
 PSYoungGen      total 6144K, used 4378K [0x00000007bf980000, 0x00000007c0000000, 0x00000007c0000000)
  eden space 5632K, 77% used [0x00000007bf980000,0x00000007bfdc6808,0x00000007bff00000)
  from space 512K, 0% used [0x00000007bff00000,0x00000007bff00000,0x00000007bff80000)
  to   space 512K, 0% used [0x00000007bff80000,0x00000007bff80000,0x00000007c0000000)
 ParOldGen       total 8192K, used 361K [0x00000007bec00000, 0x00000007bf400000, 0x00000007bf980000)
  object space 8192K, 4% used [0x00000007bec00000,0x00000007bec5a6f0,0x00000007bf400000)
 Metaspace       used 2850K, capacity 4486K, committed 4864K, reserved 1056768K
  class space    used 304K, capacity 386K, committed 512K, reserved 1048576K
Disconnected from the target VM, address: &#39;127.0.0.1:65198&#39;, transport: &#39;socket&#39;
    
    
</code></pre></td></tr></table>
</div>
</div><p>如果在垃圾回收时发现内存不足，在回收软引用所指向的对象时，<strong>软引用本身不会被清理</strong></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-10-11</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://shengtu0328.github.io/posts/jvm/" data-title="JVM学习"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://shengtu0328.github.io/posts/jvm/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://shengtu0328.github.io/posts/jvm/" data-title="JVM学习"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://shengtu0328.github.io/posts/jvm/" data-title="JVM学习"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://shengtu0328.github.io/posts/jvm/" data-title="JVM学习"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
            <a href="/posts/spring/" class="next" rel="next" title="Spring">Spring<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.92.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">ricky</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"search":{"highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
